#### 15.7.2.2 自动提交、提交和回滚



在`InnoDB`中，所有用户活动都发生在事务中。如果[`autocommit`](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_autocommit)启用了模式，则每条 SQL 语句都会自行形成一个事务。默认情况下，MySQL 为每个启用的新连接启动会话[`autocommit`](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_autocommit) ，因此如果该语句没有返回错误，MySQL 会在每个 SQL 语句之后执行提交。如果语句返回错误，则提交或回滚行为取决于错误。请参阅 [第 15.21.5 节，“InnoDB 错误处理”](https://dev.mysql.com/doc/refman/8.0/en/innodb-error-handling.html)。

已启用的会话可以通过以显式or 语句开始并以or 语句结束 [`autocommit`](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_autocommit) 来执行多语句事务 。请参阅[第 13.3.1 节，“START TRANSACTION、COMMIT 和 ROLLBACK 语句”](https://dev.mysql.com/doc/refman/8.0/en/commit.html)。 [`START TRANSACTION`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)[`BEGIN`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)[`COMMIT`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)[`ROLLBACK`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)

如果[`autocommit`](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_autocommit)在使用 的会话中禁用模式`SET autocommit = 0`，则会话始终打开事务。[`COMMIT`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)or [`ROLLBACK`](https://dev.mysql.com/doc/refman/8.0/en/commit.html) 语句结束当前事务并开始新事务 。

如果已 [`autocommit`](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_autocommit)禁用的会话在没有显式提交最终事务的情况下结束，则 MySQL 回滚该事务。

有些语句隐含地结束一个事务，就好像你[`COMMIT`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)在执行语句之前做了一个。有关详细信息，请参阅[第 13.3.3 节，“导致隐式提交的语句”](https://dev.mysql.com/doc/refman/8.0/en/implicit-commit.html)。

A[`COMMIT`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)表示在当前事务中所做的更改是永久的，并且对其他会话可见。[`ROLLBACK`](https://dev.mysql.com/doc/refman/8.0/en/commit.html) 另一方面，语句取消当前事务所做的所有修改。 同时 释放在当前事务期间设置的所有[`COMMIT`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)锁 。 [`ROLLBACK`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)`InnoDB`

##### 将 DML 操作与事务分组



默认情况下，与 MySQL 服务器的连接以 启用自动[提交](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_autocommit)模式开始，它会在您执行每个 SQL 语句时自动提交它。如果您有使用其他数据库系统的经验，则可能不熟悉这种操作模式，在这些系统中，标准做法是发出一系列 [DML](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_dml)语句并将它们一起提交或回滚。

要使用多语句 [事务](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_transaction)，请使用 SQL 语句关闭自动提交，并根据需要使用或 `SET autocommit = 0`结束每个事务 。要保持自动提交，请以 or 开始每个事务并以or 结束它 。以下示例显示了两个事务。第一个是承诺的；第二个是回滚。 [`COMMIT`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)[`ROLLBACK`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)[`START TRANSACTION`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)[`COMMIT`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)[`ROLLBACK`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)

```terminal
$> mysql test
mysql> CREATE TABLE customer (a INT, b CHAR (20), INDEX (a));
Query OK, 0 rows affected (0.00 sec)
mysql> -- Do a transaction with autocommit turned on.
mysql> START TRANSACTION;
Query OK, 0 rows affected (0.00 sec)
mysql> INSERT INTO customer VALUES (10, 'Heikki');
Query OK, 1 row affected (0.00 sec)
mysql> COMMIT;
Query OK, 0 rows affected (0.00 sec)
mysql> -- Do another transaction with autocommit turned off.
mysql> SET autocommit=0;
Query OK, 0 rows affected (0.00 sec)
mysql> INSERT INTO customer VALUES (15, 'John');
Query OK, 1 row affected (0.00 sec)
mysql> INSERT INTO customer VALUES (20, 'Paul');
Query OK, 1 row affected (0.00 sec)
mysql> DELETE FROM customer WHERE b = 'Heikki';
Query OK, 1 row affected (0.00 sec)
mysql> -- Now we undo those last 2 inserts and the delete.
mysql> ROLLBACK;
Query OK, 0 rows affected (0.00 sec)
mysql> SELECT * FROM customer;
+------+--------+
| a    | b      |
+------+--------+
|   10 | Heikki |
+------+--------+
1 row in set (0.00 sec)
mysql>
```

###### 客户端语言的交易

在 PHP、Perl DBI、JDBC、ODBC 或 MySQL 的标准 C 调用接口等 API 中，您可以将事务控制语句[`COMMIT`](https://dev.mysql.com/doc/refman/8.0/en/commit.html)作为字符串发送到 MySQL 服务器，就像任何其他 SQL 语句（如[`SELECT`](https://dev.mysql.com/doc/refman/8.0/en/select.html)or ）一样[`INSERT`](https://dev.mysql.com/doc/refman/8.0/en/insert.html)。一些 API 还提供单独的特殊事务提交和回滚函数或方法。