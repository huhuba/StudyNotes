#### 15.6.3.6 在服务器离线时移动表空间文件

该[`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories)变量定义了在启动时扫描表空间文件的目录，支持在服务器脱机时将表空间文件移动或恢复到新位置。在启动期间，使用发现的表空间文件代替数据字典中引用的那些文件，并且更新数据字典以引用重新定位的文件。如果扫描发现重复的表空间文件，则启动失败并显示错误指示为同一表空间 ID 找到多个文件。

[`innodb_data_home_dir`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_data_home_dir)由、 [`innodb_undo_directory`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_undo_directory)和 变量 定义的目录 [`datadir`](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_datadir)会自动附加到 [`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories)参数值。无论是否[`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories) 明确指定设置，都会在启动时扫描这些目录。这些目录的隐式添加允许在不配置 [`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories)设置的情况下移动系统表空间文件、数据目录或撤消表空间文件。但是，必须在目录更改时更新设置。例如，重新定位数据目录后，您必须 [`--datadir`](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_datadir)在重新启动服务器之前更新设置。

该[`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories)变量可以在启动命令或 MySQL 选项文件中指定。引号用于参数值周围，因为分号 (;) 被某些命令解释器解释为特殊字符。（例如，Unix shell 将其视为命令终止符。）

启动命令：

```terminal
mysqld --innodb-directories="directory_path_1;directory_path_2"
```

MySQL 选项文件：

```ini
[mysqld]
innodb_directories="directory_path_1;directory_path_2"
```

以下过程适用于移动单个 [文件每个表](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_file_per_table)和 [通用表空间](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_general_tablespace) 文件、[系统表空间](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_system_tablespace)文件、[撤消表空间](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_undo_tablespace)文件或数据目录。在移动文件或目录之前，请查看以下使用说明。

1. 停止服务器。
2. 将表空间文件或目录移动到所需位置。
3. 使新目录为`InnoDB`.
   - 如果移动单个 [文件每个表](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_file_per_table) 或[通用表空间](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_general_tablespace)文件，请将未知目录添加到该 [`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories)值。
     - [`innodb_data_home_dir`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_data_home_dir)由、 [`innodb_undo_directory`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_undo_directory)和变量 定义的目录 [`datadir`](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_datadir)会自动附加到 [`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories) 参数值，因此您无需指定这些。
     - file-per-table 表空间文件只能移动到与模式同名的目录。例如，如果`actor`表属于 `sakila`模式，则 `actor.ibd`数据文件只能移动到名为 `sakila`.
     - 通用表空间文件不能移动到数据目录或数据目录的子目录。
   - 如果移动系统表空间文件、撤消表空间或数据目录，请根据需要更新 [`innodb_data_home_dir`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_data_home_dir)、 [`innodb_undo_directory`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_undo_directory)和[`datadir`](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_datadir)设置。
4. 重新启动服务器。

##### 使用说明

- [`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories)参数值 中不能使用通配符表达式 。

- 扫描还遍历指定目录的[`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories)子目录。从要扫描的目录列表中丢弃重复的目录和子目录。

- [`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories)支持移动`InnoDB`表空间文件。不支持移动属于存储引擎以外 `InnoDB`的文件。此限制也适用于移动整个数据目录。

- [`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories)支持将文件移动到扫描目录时重命名表空间文件。它还支持将表空间文件移动到其他支持的操作系统。

- 将表空间文件移动到不同的操作系统时，请确保表空间文件名不包含禁止字符或在目标系统上具有特殊含义的字符。

- 将数据目录从 Windows 操作系统移动到 Linux 操作系统时，将二进制日志索引文件中的二进制日志文件路径修改为使用反斜杠而不是正斜杠。默认情况下，二进制日志索引文件与二进制日志文件具有相同的基本名称，扩展名为 ' `.index`'。二进制日志索引文件的位置由 [`--log-bin`](https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#option_mysqld_log-bin). 默认位置是数据目录。

- 如果将表空间文件移动到不同的操作系统会引入跨平台复制，那么数据库管理员有责任确保正确复制包含特定于平台的目录的 DDL 语句。允许指定目录的语句包括 [`CREATE TABLE ... DATA DIRECTORY`](https://dev.mysql.com/doc/refman/8.0/en/create-table.html)和 [`CREATE TABLESPACE ... ADD DATAFILE`](https://dev.mysql.com/doc/refman/8.0/en/create-tablespace.html)。

- 将使用绝对路径或在数据目录之外的位置创建的 file-per-table 和常规表空间的目录添加到 [`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories)设置中。否则，`InnoDB`在恢复过程中无法找到文件。有关相关信息，请参阅 [崩溃恢复期间的表空间发现](https://dev.mysql.com/doc/refman/8.0/en/innodb-recovery.html#innodb-recovery-tablespace-discovery)。

  要查看表空间文件位置，请查询 [`INFORMATION_SCHEMA.FILES`](https://dev.mysql.com/doc/refman/8.0/en/information-schema-files-table.html)表：

  ```sql
  mysql> SELECT TABLESPACE_NAME, FILE_NAME FROM INFORMATION_SCHEMA.FILES \G
  ```