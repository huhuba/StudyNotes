### 15.6.6 撤消日志

撤消日志是与单个读写事务关联的撤消日志记录的集合。撤消日志记录包含有关如何撤消事务对[聚集索引](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_clustered_index) 记录的最新更改的信息。如果另一个事务需要将原始数据视为一致读取操作的一部分，则从撤消日志记录中检索未修改的数据。撤消日志存在于 [撤消日志段](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_undo_log_segment)中，这些段包含在 [回滚段中](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_rollback_segment)。回滚段驻留在 [撤消表空间](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_undo_tablespace)和[全局临时表空间](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_global_temporary_tablespace)中。

驻留在全局临时表空间中的撤消日志用于修改用户定义临时表中数据的事务。这些撤消日志不是重做日志，因为它们不是崩溃恢复所必需的。它们仅用于在服务器运行时进行回滚。这种类型的撤消日志通过避免重做日志记录 I/O 来提高性能。

有关撤消日志的静态数据加密的信息，请参阅 [撤消日志加密](https://dev.mysql.com/doc/refman/8.0/en/innodb-data-encryption.html#innodb-data-encryption-undo-log)。

每个 undo 表空间和全局临时表空间分别支持最多 128 个回滚段。该 [`innodb_rollback_segments`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_rollback_segments)变量定义回滚段的数量。

回滚段支持的事务数取决于回滚段中的撤消槽数和每个事务所需的撤消日志数。回滚段中撤消槽的数量因 `InnoDB`页面大小而异。

| InnoDB 页面大小 | 回滚段中的撤消槽数（InnoDB 页面大小 / 16） |
| :-------------- | :----------------------------------------- |
| `4096 (4KB)`    | `256`                                      |
| `8192 (8KB)`    | `512`                                      |
| `16384 (16KB)`  | `1024`                                     |
| `32768 (32KB)`  | `2048`                                     |
| `65536 (64KB)`  | `4096`                                     |

一个事务最多被分配四个撤消日志，一个用于以下操作类型中的每一种：

1. [`INSERT`](https://dev.mysql.com/doc/refman/8.0/en/insert.html)对用户定义表的操作
2. [`UPDATE`](https://dev.mysql.com/doc/refman/8.0/en/update.html)以及 [`DELETE`](https://dev.mysql.com/doc/refman/8.0/en/delete.html)对用户定义表的操作
3. [`INSERT`](https://dev.mysql.com/doc/refman/8.0/en/insert.html)对用户定义的临时表的操作
4. [`UPDATE`](https://dev.mysql.com/doc/refman/8.0/en/update.html)以及 [`DELETE`](https://dev.mysql.com/doc/refman/8.0/en/delete.html)对用户定义的临时表的操作

根据需要分配撤消日志。例如，对常规表和临时表执行[`INSERT`](https://dev.mysql.com/doc/refman/8.0/en/insert.html)、、 [`UPDATE`](https://dev.mysql.com/doc/refman/8.0/en/update.html)和 [`DELETE`](https://dev.mysql.com/doc/refman/8.0/en/delete.html)操作的事务需要完整分配四个撤消日志。仅对常规表执行 [`INSERT`](https://dev.mysql.com/doc/refman/8.0/en/insert.html)操作的事务需要单个撤消日志。

对常规表执行操作的事务从分配的撤消表空间回滚段分配撤消日志。对临时表执行操作的事务从分配的全局临时表空间回滚段分配撤消日志。

分配给事务的撤消日志在其持续时间内保持附加到事务。例如，为[`INSERT`](https://dev.mysql.com/doc/refman/8.0/en/insert.html) 常规表上的操作分配给事务的撤消日志用于该事务在常规表上执行的所有 [`INSERT`](https://dev.mysql.com/doc/refman/8.0/en/insert.html)操作。

`InnoDB`考虑到上述因素，下面的公式可以用来估计能够支持 的并发读写事务的数量。

笔记

`InnoDB`在达到能够支持 的并发读写事务数之前，可能会遇到并发事务限制错误。当分配给事务的回滚段用完撤消槽时，就会发生这种情况。在这种情况下，请尝试重新运行事务。

当事务对临时表进行操作时，能够支持的并发读写事务 `InnoDB`数受分配给全局临时表空间的回滚段数的限制，默认为128。

- 如果每个事务执行一个 **或**一个 或 操作，则能够支持 的并发读写事务数 为：[`INSERT`](https://dev.mysql.com/doc/refman/8.0/en/insert.html) [`UPDATE`](https://dev.mysql.com/doc/refman/8.0/en/update.html)[`DELETE`](https://dev.mysql.com/doc/refman/8.0/en/delete.html)`InnoDB`

  ```none
  (innodb_page_size / 16) * innodb_rollback_segments * number of undo tablespaces
  ```

- 如果每个事务都执行 **and** an or 操作，则能够支持 的并发读写事务数 为：[`INSERT`](https://dev.mysql.com/doc/refman/8.0/en/insert.html) [`UPDATE`](https://dev.mysql.com/doc/refman/8.0/en/update.html)[`DELETE`](https://dev.mysql.com/doc/refman/8.0/en/delete.html)`InnoDB`

  ```none
  (innodb_page_size / 16 / 2) * innodb_rollback_segments * number of undo tablespaces
  ```

- 如果每个事务对一个临时表执行一个 操作，则能够支持 [`INSERT`](https://dev.mysql.com/doc/refman/8.0/en/insert.html)的并发读写事务数 为：`InnoDB`

  ```none
  (innodb_page_size / 16) * innodb_rollback_segments
  ```

- 如果每个事务对临时表执行 **and** an or 操作，则能够支持 的并发读写事务数 为：[`INSERT`](https://dev.mysql.com/doc/refman/8.0/en/insert.html) [`UPDATE`](https://dev.mysql.com/doc/refman/8.0/en/update.html)[`DELETE`](https://dev.mysql.com/doc/refman/8.0/en/delete.html)`InnoDB`

  ```none
  (innodb_page_size / 16 / 2) * innodb_rollback_segments
  ```