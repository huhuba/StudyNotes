#### 15.6.1.2 外部创建表

`InnoDB` 在外部 创建表有不同的原因；也就是说，在数据目录之外创建表。例如，这些原因可能包括空间管理、I/O 优化或将表放置在具有特定性能或容量特征的存储设备上。

`InnoDB`支持以下外部建表方式：

- [使用数据目录子句](https://dev.mysql.com/doc/refman/8.0/en/innodb-create-table-external.html#innodb-create-table-external-data-directory)
- [使用 CREATE TABLE ... TABLESPACE 语法](https://dev.mysql.com/doc/refman/8.0/en/innodb-create-table-external.html#innodb-create-table-external-tablespace-syntax)
- [在外部通用表空间中创建表](https://dev.mysql.com/doc/refman/8.0/en/innodb-create-table-external.html#innodb-create-table-external-tablespace)

##### 使用数据目录子句

您可以通过在语句中指定子句在`InnoDB`外部目录 中创建表。 `DATA DIRECTORY``CREATE TABLE`

```sql
CREATE TABLE t1 (c1 INT PRIMARY KEY) DATA DIRECTORY = '/external/directory';
```

`DATA DIRECTORY`在 file-per-table 表空间中创建的表支持 该子句。[`innodb_file_per_table`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_file_per_table)启用该变量 时，表会在每个表的文件表空间中隐式创建， 默认情况下是这样。

```sql
mysql> SELECT @@innodb_file_per_table;
+-------------------------+
| @@innodb_file_per_table |
+-------------------------+
|                       1 |
+-------------------------+
```

有关 file-per-table 表空间的更多信息，请参阅 [第 15.6.3.2 节，“File-Per-Table 表空间”](https://dev.mysql.com/doc/refman/8.0/en/innodb-file-per-table-tablespaces.html)。

当您在语句中指定`DATA DIRECTORY`子句时 ，将在指定目录下的模式目录中创建 `CREATE TABLE`表的数据文件 ( )。`*`table_name`*.ibd`

从 MySQL 8.0.21 开始，使用该`DATA DIRECTORY`子句在数据目录之外创建的表和表分区仅限于`InnoDB`. 此要求允许数据库管理员控制在何处创建表空间数据文件，并确保在恢复期间可以找到数据文件（请参阅[崩溃恢复期间的表空间发现](https://dev.mysql.com/doc/refman/8.0/en/innodb-recovery.html#innodb-recovery-tablespace-discovery)）。已知目录是由 [`datadir`](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_datadir)、 [`innodb_data_home_dir`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_data_home_dir)和 [`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories)变量定义的目录。您可以使用以下语句检查这些设置：

```sql
mysql> SELECT @@datadir,@@innodb_data_home_dir,@@innodb_directories;
```

如果您要使用的目录未知， [`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories)请在创建表之前将其添加到设置中。该 [`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories)变量是只读的。配置它需要重新启动服务器。有关设置系统变量的一般信息，请参阅 [第 5.1.9 节，“使用系统变量”](https://dev.mysql.com/doc/refman/8.0/en/using-system-variables.html)。

`DATA DIRECTORY` 以下示例演示了使用该子句 在外部目录中创建表。假定该 [`innodb_file_per_table`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_file_per_table)变量已启用并且该目录是已知的 `InnoDB`。

```sql
mysql> USE test;
Database changed

mysql> CREATE TABLE t1 (c1 INT PRIMARY KEY) DATA DIRECTORY = '/external/directory';

# MySQL creates the table's data file in a schema directory
# under the external directory

$> cd /external/directory/test
$> ls
t1.ibd
```

###### 使用说明：

- MySQL 最初保持表空间数据文件处于打开状态，从而阻止您卸载设备，但如果服务器繁忙，最终可能会关闭该文件。注意不要在 MySQL 运行时意外卸载外部设备，或者在设备断开连接时启动 MySQL。在缺少关联的数据文件时尝试访问表会导致严重错误，需要重新启动服务器。

  如果在预期路径中找不到数据文件，则服务器重新启动可能会失败。[在这种情况下，您可以从备份中恢复表空间数据文件或删除表以从数据字典](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_data_dictionary)中删除有关它的信息 。

- [在将表放在 NFS 挂载的卷上之前，请查看将 NFS 与 MySQL 一起使用](https://dev.mysql.com/doc/refman/8.0/en/disk-issues.html#disk-issues-nfs) 中概述的潜在问题 。

- 如果使用 LVM 快照、文件复制或其他基于文件的机制来备份表的数据文件，请始终 [`FLUSH TABLES ... FOR EXPORT`](https://dev.mysql.com/doc/refman/8.0/en/flush.html#flush-tables-for-export-with-list)首先使用该语句以确保在备份发生之前将缓冲在内存中的所有更改 [刷新](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_flush)到磁盘。

- 使用该`DATA DIRECTORY`子句在外部目录中创建表是使用 不支持 的[符号链接](https://dev.mysql.com/doc/refman/8.0/en/symbolic-links.html)的 替代方法。`InnoDB`

- `DATA DIRECTORY`在源和副本位于同一主机上的复制环境中不支持 该子句。该`DATA DIRECTORY`子句需要完整的目录路径。在这种情况下复制路径将导致源和副本在同一位置创建表。

- 从 MySQL 8.0.21 开始，在 file-per-table 表空间中创建的表不能再在 undo 表空间目录 ( [`innodb_undo_directory`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_undo_directory)) 中创建，除非`InnoDB`. 已知目录是由 [`datadir`](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_datadir)、 [`innodb_data_home_dir`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_data_home_dir)和 [`innodb_directories`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_directories) 变量定义的目录。

##### 使用 CREATE TABLE ... TABLESPACE 语法

[`CREATE TABLE ... TABLESPACE`](https://dev.mysql.com/doc/refman/8.0/en/create-table.html)语法可以与该 `DATA DIRECTORY`子句结合使用以在外部目录中创建表。为此，请指定 `innodb_file_per_table`为表空间名称。

```sql
mysql> CREATE TABLE t2 (c1 INT PRIMARY KEY) TABLESPACE = innodb_file_per_table
       DATA DIRECTORY = '/external/directory';
```

此方法仅支持在 file-per-table 表空间中创建的表，但不需要 [`innodb_file_per_table`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_file_per_table)启用该变量。在所有其他方面，此方法与上述方法等效`CREATE TABLE ... DATA DIRECTORY`。适用相同的使用说明。

##### 在外部通用表空间中创建表

您可以在驻留在外部目录中的通用表空间中创建表。

- 有关在外部目录中创建通用表空间的信息，请参阅 [创建通用表空间](https://dev.mysql.com/doc/refman/8.0/en/general-tablespaces.html#general-tablespaces-creating)。
- 有关在通用表空间中创建表的信息，请参阅 [将表添加到通用表空间](https://dev.mysql.com/doc/refman/8.0/en/general-tablespaces.html#general-tablespaces-adding-tables)。